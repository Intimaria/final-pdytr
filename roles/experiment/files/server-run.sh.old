#!/bin/bash

# Ensure variables are set
PORT="${PORT:?Port is not set}"
CPU_LOAD="${CPU_LOAD:?CPU load flag is not set}"

# Kill other processes running on the same port
if fuser -k "${PORT}/tcp" 2>/dev/null; then
    echo "Killed existing processes on port $PORT"
fi

echo "Starting server: PORT=$PORT, CPU_LOAD=$CPU_LOAD"

# Run experiments
for exp in 3 4 5 6 7; do
    size=$((10**exp))
    echo "Running server with buffer size: $size"

    # Execute server binary
    ./server "$PORT" "$size" "$CPU_LOAD" &
    SERVER_PID=$!

    # Wait for the server to complete
    wait $SERVER_PID
    if [ $? -ne 0 ]; then
        echo "Error: Server failed for buffer size $size" >&2
        exit 1
    fi

    echo -e "$size\tCompleted"
    sleep 1
done

echo "Server experiments completed."
