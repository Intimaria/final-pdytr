# roles/experiment/tasks/run_iteration.yml
- name: Debug experiment type
  debug:
    msg: "Experiment type is: {{ experiment_type }}"

- name: Debug cpu_load
  debug:
    msg: "CPU Load is: {{ cpu_load }}"

- name: Debug server start command
  debug:
    msg: "Starting server with: ./server {{ server_port }} {{ current_buffer_size }} {{ cpu_load }}"
  delegate_to: "{{ groups['ntp_server'][0] }}"

- name: Start server
  shell: "./server {{ server_port }} {{ current_buffer_size }} {{ cpu_load }}"
  args:
    chdir: "{{ experiment_dir }}"
  async: 3600
  poll: 0
  delegate_to: "{{ groups['ntp_server'][0] }}"

- name: Wait for server to be ready
  wait_for:
    host: "{{ hostvars[groups['ntp_server'][0]].ansible_host }}"
    port: "{{ server_port }}"
    state: started
    timeout: 30

- name: Debug client command
  debug:
    msg: "Running client with: ./client {{ hostvars[groups['ntp_server'][0]].ansible_host }} {{ server_port }} {{ current_buffer_size }} {{ clock_offset }}"

- name: Run client
  shell: "./client {{ hostvars[groups['ntp_server'][0]].ansible_host }} {{ server_port }} {{ current_buffer_size }} {{ clock_offset }} > client.log 2>&1"
  args:
    chdir: "{{ experiment_dir }}"
  async: 3600
  register: client_output
  poll: 5
  until: client_output.rc == 0
  ignore_errors: yes

- name: Terminate client process after timeout
  shell: "pkill -f './client'"
  ignore_errors: yes

- name: Fetch client log
  fetch:
    src: "{{ experiment_dir }}/client.log"
    dest: "{{ experiment_dir }}/client_{{ current_buffer_size }}.log"

- name: Debug client output
  debug:
    msg: "{{ client_output.stdout }}"

- name: Collect client output
  copy:
    content: "{{ client_output.stdout }}"
    dest: "{{ experiment_dir }}/results/result_{{ current_buffer_size }}_{{ iteration }}_load_{{ experiment_type }}.txt"

- name: Stop server
  shell: "pkill -f './server {{ server_port }} {{ current_buffer_size }} {{ cpu_load }}'"
  ignore_errors: yes
  delegate_to: "{{ groups['ntp_server'][0] }}"
